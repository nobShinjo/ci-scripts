# Title: git-config.yml
#
# Description:
# This script is designed to configure Git for the CI/CD pipeline.
# It sets up the Git author name and email, installs necessary tools, and configures CA certificates.
# It is used in a GitLab CI/CD pipeline.

.git-config:
  variables:
    GIT_AUTHOR_NAME: "gitlab-ci"
    GIT_AUTHOR_EMAIL: "ci@example.com"
    CA_STORE_DIR: "/usr/local/share/ca-certificates"
  before_script:
    # Install git and configure GitLab CI job token
    - |
      echo "‚öôÔ∏è Setting up Git configuration..."
      echo "üì¶ Install necessary tools..."
      apk add --no-cache git ca-certificates > /dev/null 2>&1
      echo "üì¶ Tool Versions:"
      git --version
      apk list --installed ca-certificates
    # Configure GitLab CI job token
    - |
      echo "üîë Configure GitLab CI job token..."
      cat <<EOF > ~/.netrc
      machine ${CI_SERVER_HOST}
        login gitlab-ci-token
        password ${CI_JOB_TOKEN}
      EOF
      chmod 600 ~/.netrc
    # Update CA certificates
    - |
      echo "üîÑ Update CA certificates..."
      CERT_PATH="${CI_SERVER_TLS_CA_FILE:-/etc/gitlab-runner/certs/root.crt}"
      echo "Using CA cert: $CERT_PATH"
      if [ ! -f "$CERT_PATH" ]; then
        echo "‚ùå CA certificate not found at $CERT_PATH"
        exit 1;
      fi
      cp "$CERT_PATH" "$CA_STORE_DIR/$(basename "$CERT_PATH")"
      update-ca-certificates
    # Configure Git to use the CA certificate
    - |
      echo "üîë Configure Git author name: ${GIT_AUTHOR_NAME} and email: ${GIT_AUTHOR_EMAIL} ..."
      git config --global user.name "${GIT_AUTHOR_NAME}"
      git config --global user.email "${GIT_AUTHOR_EMAIL}"
      echo "üîë Configure Git SSL CA info..."
      git config --global http.sslCAInfo "$CERT_PATH"
      remote_repo_url=https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
      echo "üîë Configure Git remote URL ${remote_repo_url}..."
      git remote set-url origin ${remote_repo_url}
      echo "‚úÖ Successfully set up Git configuration."
