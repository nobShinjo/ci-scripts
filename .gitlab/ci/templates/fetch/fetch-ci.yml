# Title: fetch-ci.yml
#
# Description:
# This script is designed to fetch CI scripts from a GitLab repository.
# It clones the ci-scripts repository, copies the necessary files to the current directory.
# This ensures that the latest CI scripts are always used.
#
# Requires:
#   - GitLab CI/CD runner with Docker executor.
#   - Allow CI job token from other projects in the GitLab settings.
#     GitLab `ci-scripts` repository Settings:
#     Settings > CI/CD > Job token permissions > CI/CD job token allowlist
#     Add the `Group` or `Project`.
#

.fetch_ci:
  variables:
    CA_STORE_DIR: "/usr/local/share/ca-certificates"
    CI_REPOSITORY: "https://gitlab.ubuntu.local/linesimulation/unity-npm/ci-scripts.git"
    CI_BRANCH: "feature/add-ci-templates"
  script:
    # If `ci-scripts` directory exists, fetch the latest changes.
    # Otherwise, clone the repository.
    - |
      echo "ðŸ”„ Fetching CI scripts..."
      if [ -d ".gitlab" ]; then
        echo "ðŸ”„ CI scripts found. Fetching latest changes..."
        cd .gitlab && git fetch --all && git reset --hard origin/main && cd ..
        echo "âœ… CI scripts updated successfully."
        exit 0
      fi
      echo "ðŸ“¥ CI scripts not found. Cloning repository..."
      git clone --depth=1 --branch "$CI_BRANCH" "$CI_REPOSITORY" tmp_ci
      mkdir -p .gitlab
      cp -r tmp_ci/.gitlab/* .gitlab/
      rm -rf tmp_ci
      echo "âœ… CI scripts cloned successfully."
  artifacts:
    name: "ci-scripts"
    paths:
      - .gitlab/
    expire_in: 1 day
